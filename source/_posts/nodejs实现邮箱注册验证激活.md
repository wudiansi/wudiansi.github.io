---
title: nodejs实现邮箱注册验证激活
date: 2018-04-17 15:54:42
tags: 
  - node
  - nodemailer
  - js
categories:
    node 
---

### 前言

这两天要实现一个通过邮箱注册然后自动发送激活邮件给用户，然后用户进入自己邮箱点击邮件中的链接实现激活邮箱的需求。算是一个比较常见简单的需求，但是是第一次做，还是值得记录一下。以便于以后的总结。

---

### 思路
> 发送激活邮件，当然第一件事就是得有邮箱了，作为公司业务的话应该就是有自己专门的企业邮箱。如果没有没关系，自己注册一个啦(推荐腾讯的企业邮箱或者网易的126邮箱，都是免费、稳定、简洁的邮箱)，之后就去邮箱的设置界面设置。找到`设置栏`，一般选择`POP3/SMTP/IMAP`，开启`POP3/SMTP/IMAP`服务，最后在设置一下授权码就算完成第一步了。

1. 首先数据库里面需要有三个字段。`state`(0:未激活，1:已激活)、`code`(激活码 uuid(20))、`effective_time`(激活码有效期(生成链接24小时内))

2. 用户填写邮箱，填写密码重复密码后提交注册，后台接受数据，插入用户这条数据成功。`state`默认为0未激活，并生成一个`code`（最好是通过传过来的邮箱、密码这些数据融合后加密生成），同时存入数据库。

3. 发送邮件到用户注册用的邮箱，并且提示用户登录刚刚的邮箱验证激活。邮件正文中带一个`email`（这里最好是用户的`uid`比较合适）和`code`两个参数的URL供用户点击验证。

4. 用户登录自己的邮箱，读取我们发送的验证邮件，用户通过点击链接或者复制地址访问的方式来到我们的业务邮箱验证页面。然后得到`url`里的两个参数，查阅数据库验证是否存在用户或验证码，不存在则为错误的验证链接地址。如存在则验证对应的`有效期`是够小于当前时间，没过期则最后验证两个字段是否一一对应，全部通过则算激活成功。设置`state`字段为1。跳转至登录页面，否则验证失败跳转至验证失败页面。

### 先来认识一下`nodemailer`

- zero dependencies /零依赖
- Heavy focus on security /重安全
- Unicode support /支持任何字符 甚至 emoji 👻
- Windows support windows /快速install
- Use HTML content, as well as plain text alternative 支持纯文本更甚至html语言
- Add Attachments to messages /可附件/
- Embedded image attachments for HTML content /嵌入img至你的html中
- Secure email delivery using TLS/STARTTLS /安全邮件
- Different transport methods in addition to the built-in SMTP support /不同传输方式
- Sign messages with DKIM /用DKIM签名
- Custom Plugin support for manipulating messages /自定义插件操纵消息
- Sane OAuth2 authentication /OAuth2认证
- Proxies for SMTP connections /代理
- ES6 code – no more unintentional memory leaks, due to hoisted var’s /ES6
- Autogenerated email test accounts from Ethereal.email

> node版本v6.0+

总之就是`nodemailer`这个库很牛逼，先安装具体看[官网](https://nodemailer.com/about/)。

``` js
npm install nodemailer --save
```

来看具体的代码

``` js
'use strict';
const nodemailer = require('nodemailer');


// 接入的是腾讯企业邮箱这里分别填入你设置的账号和pass
let transporter = nodemailer.createTransport({
    service: 'QQex',
    auth: {
        user: '',// 邮箱
        pass: ''// pass
    }
});


const sendRegisterCodeUrl = exports.sendRegisterCodeUrl = (item)=>{
  let {email, code} = item;
  console.log('get email~ code~',email, code);

  try{
    let text = `尊敬的${email}，您好, 

    感谢您参加比***活动。 
    请点击以下链接进行邮箱验证，以便开始您的***： 

    https://example.com?mail=${email}&code=${code} 
    如果您并未参加***活动，可能是其他用户误输入了您的邮箱地址。请忽略此邮件，或者联系我们。 
    
    
    ***** - ***
    广东省广州市番禺区********************** / 020-******* `;

    let mailOptions = {
      subject: '邮箱激活通知', // Subject line
      from: '"发件方大名" <example@abc.cc>', // 可设置发件人主题
      to: `${email}`, //收件人的邮箱地址
      text: text, // 纯文本形式
      html: getRegisterHtml(email, code) // html 形式（可设置按钮，邮件内容样式）
    };

    // 调取发送邮件方法
    transporter.sendMail(mailOptions, (error, info) => {
      if (error) {
          return console.log('发送邮件出错：', error);
      }
      return console.log('Message %s sent: %s', info.messageId, info.response);
    });

  }catch(e){
    console.log('发送邮件出错：',e);
  }
}
```

下面是具体的HTML格式的内容

``` js
/** 
* 传入需要的参数
* 生成你想要呈现的文件形式
*/
function getRegisterHtml(email, code){
  let html = `<div>这里是HTML~</div>
  `;
  return html;
}
```

### 小结
到这里基本的业务发送邮件的地方就算是简答实现了，但是严格上来说还是有很多值得改进的地方，比如在验证生成`code`的地方，应该是用用户的相关联信息邮箱来生成加密后的code码而不是直接的生成，同样的在验证激活地址的时候应该传入的是用户的`uid`而不是`email`地址，虽然觉得没什么毛病，但是还是感觉怪怪的说不上严禁。再则就是`nodemailer`的功能的确很强大，我只是使用到了一丁点的皮毛，比如邮件附件的添加、邮箱日历事件接入、List headers等等都没有用上。值得我去更加深入的运用它，以至在今后的需求实现中得以得心应手~
